/*
 * Â© 2023. This work is openly licensed via CC0 1.0.
 * https://creativecommons.org/publicdomain/zero/1.0/
 */

package com.fjellsoftware.retaildemo.domain;

import com.fjellsoftware.retaildemo.autogenerated.orm.*;
import io.loppi.orm.*;
import io.loppi.graphql.*;
import io.loppi.graphql.schema.GraphQLErrorTypeCategory;
import io.loppi.includablevalues.*;
import io.loppi.includablevalues.IntValue;
import io.loppi.orm.metamodel.*;
import io.loppi.orm.query.DatabaseQuery;
import com.fjellsoftware.retaildemo.authorizationcommon.MutationFieldAndCookies;
import com.fjellsoftware.javafunctionalutils.ImmutableList;
import com.fjellsoftware.javafunctionalutils.ImmutableSet;
import com.fjellsoftware.retaildemo.ApplicationInternalException;
import com.fjellsoftware.retaildemo.authorizationcommon.userinfo.AuthenticatedUser;
import com.fjellsoftware.retaildemo.authorizationcommon.userinfo.UserInfo;
import com.fjellsoftware.retaildemo.autogenerated.graphql.customer.OrderInsertMutationInput;
import com.fjellsoftware.retaildemo.autogenerated.graphql.customer.OrdersQueryField;
import com.fjellsoftware.retaildemo.autogenerated.graphql.customer.PlaceOrderMutationField;
import com.fjellsoftware.retaildemo.autogenerated.graphql.staff.OrderStatusBatchUpdateMutationField;

import java.math.BigDecimal;
import java.time.OffsetDateTime;
import java.time.ZoneOffset;
import java.util.*;

import static com.fjellsoftware.retaildemo.domain.OrderStatusEnum.IN_PROGRESS;
import static com.fjellsoftware.retaildemo.domain.OrderStatusEnum.SHIPPED;

public class OrderDomain {

    private final PurchaseOrderMeta purchaseOrderMeta;
    private final UserAccountMeta userAccountMeta;
    private final ProductMeta productMeta;
    private final DatabaseServiceJDBCRetailDemo databaseService;
    private final ImmutableSet<Integer> originalDatasetIds;

    public OrderDomain(LoppiServiceRetailDemo loppiService) {
        this.databaseService = loppiService.getDatabaseServiceJDBC();
        MetaRetailDemo meta = loppiService.getMeta();
        this.purchaseOrderMeta = meta.getPurchaseOrderMeta();
        this.userAccountMeta = meta.getUserAccountMeta();
        this.productMeta = meta.getProductMeta();

        DatabaseServiceJDBCRetailDemo databaseServiceJDBC = loppiService.getDatabaseServiceJDBC();
        OffsetDateTime startOf2022 = OffsetDateTime.of(2022, 1, 1, 0, 0, 0, 0, ZoneOffset.UTC);
        DatabaseQuery<PurchaseOrderResult> query = databaseServiceJDBC.createQueryBuilder(purchaseOrderMeta.getEntityMetadata().getQueryResultClass(), 100_000)
                .where().lt(purchaseOrderMeta.createdAt, startOf2022).end()
                .includeScalar(purchaseOrderMeta.purchaseOrderId)
                .build();
        try {
            ImmutableList<PurchaseOrderResult> orderResults = databaseServiceJDBC.executeQuery(query).deserialize();
            Set<Integer> originalDatasetIdsTmp = new HashSet<>();
            for (PurchaseOrderResult orderResult : orderResults) {
                int id = ((IntValue) orderResult.getPurchaseOrderId()).getValue();
                originalDatasetIdsTmp.add(id);
            }
            this.originalDatasetIds = new ImmutableSet<>(originalDatasetIdsTmp);
        } catch (PostgresExecutionException e) {
            throw new ApplicationInternalException("Failed to initialize valid purchaseOrder ids for initial dataset.", e);
        }
    }

    private final static String apiBaseName = "Order";
    private final static String apiPluralName = "Orders";

    public static GraphQLTypeConfiguration<PurchaseOrderResult>
    createCustomerApiTypeConfiguration(PurchaseOrderMeta purchaseOrderMeta){
        Set<Attribute<PurchaseOrderResult, ?>> outputAttributes =
                Set.of( purchaseOrderMeta.purchaseOrderId,
                        purchaseOrderMeta.orderStatus,
                        purchaseOrderMeta.createdAt,
                        purchaseOrderMeta.orderLines);
        GraphQLDatabaseQueryConfiguration<PurchaseOrderResult> queryConfiguration =
                new GraphQLDatabaseQueryConfiguration<>(outputAttributes)
                .setIncludePluralRootField(true)
                .setIncludeWhere(Set.of(purchaseOrderMeta.purchaseOrderId),
                        false)
                .setIncludeOrderBy(Set.of(purchaseOrderMeta.createdAt))
                .setPluralFieldDescription(
                        "Returns orders registered for currently logged in user.");
        GraphQLMutationsConfiguration<PurchaseOrderResult> mutationConfiguration =
                new GraphQLMutationsConfiguration<>(outputAttributes)
                .setIncludeInsert(Set.of(
                        purchaseOrderMeta.orderLines,
                        purchaseOrderMeta.countryId,
                        purchaseOrderMeta.address,
                        purchaseOrderMeta.name,
                        purchaseOrderMeta.phoneNumber),
                        "placeOrder",
              "Place an order for purchase. Set customerId to associate " +
                        "order with logged in account. Maximum order lines: 50.");
        return new GraphQLTypeConfiguration<>(purchaseOrderMeta.getEntityMetadata())
                .setIncludeQuery(queryConfiguration)
                .setIncludeMutations(mutationConfiguration)
                .setTypeName("Order", "Orders");
    }

    public GraphQLExecutableQueryField applyAccessControlCustomerQuery(
            OrdersQueryField ordersQueryField, UserInfo userInfo) throws GraphQLRequestException {
        //User should only be able to look at own orders.
        if(!(userInfo instanceof AuthenticatedUser authenticatedUser)){
            throw GraphQLRequestException.createNotLoggedIn();
        }
        GraphQLDatabaseQueryFieldSimpleArguments<PurchaseOrderResult> query = ordersQueryField.queryField();
        return GraphQLDatabaseQuerySimpleArgumentBuilder.from(query)
                .getNestedOrIncludeForWhere(purchaseOrderMeta.customer)
                .where().eq(userAccountMeta.userAccountId, authenticatedUser.userId())
                .end().end1().build();
    }

    private static final String VALID_ADDRESS = "123 Maple Street, Anytown";
    private static final String VALID_NAME = "John Doe";
    private static final String VALID_PHONE_NUMBER = "+44 808 157 0192";
    public MutationFieldAndCookies handlePlaceOrder(UserInfo userInfo, PlaceOrderMutationField placeOrderMutationField) throws GraphQLRequestException {
        OrderInsertMutationInput input = placeOrderMutationField.input();
        PurchaseOrderToInsert purchaseOrderToInsert = input.purchaseOrderToInsert();

        if(!purchaseOrderToInsert.getAddress().equals(VALID_ADDRESS)){
            throw new GraphQLValidationException("In this demo the address must be: \"123 Maple Street, Anytown\" on order placements.");
        }
        if(!purchaseOrderToInsert.getName().equals(VALID_NAME)){
            throw new GraphQLValidationException("In this demo the name must be: \"John Doe\" on order placements.");
        }
        if(!purchaseOrderToInsert.getPhoneNumber().equals(VALID_PHONE_NUMBER)){
            throw new GraphQLValidationException("In this demo the phone number must be: \"+44 808 157 0192\" on order placements.");
        }
        if(userInfo instanceof AuthenticatedUser authenticatedUser){
            purchaseOrderToInsert.setCustomerIncludableOf(new RetailDemoIdReferenceUUID(authenticatedUser.userId()));
        }

        ImmutableList<OrderLineToInsert> orderLinesToInsert = input.orderLines();
        if(orderLinesToInsert.isEmpty()){
            throw new GraphQLRequestException("Order placement must have at least one order line.", GraphQLErrorTypeCategory.OTHER);
        }
        if (orderLinesToInsert.size() > 50) {
            throw new GraphQLRequestException("Request too big.", GraphQLErrorTypeCategory.OTHER);
        }

        Map<Integer, BigDecimal> productIdPrices = new HashMap<>();
        for (OrderLineToInsert orderLineToInsert : orderLinesToInsert) {
            ProductReference productReference = orderLineToInsert.getProduct();
            if(!(productReference instanceof RetailDemoIdReferenceInt referenceInt)){
                throw GraphQLRequestException.createInternal();
            }
            int id = referenceInt.getId();
            BigDecimal unitPrice = orderLineToInsert.getUnitPrice();
            productIdPrices.put(id, unitPrice);
        }
        DatabaseQuery<ProductResult> query = databaseService.createQueryBuilder(ProductResult.class, productIdPrices.size())
                .where().intIn(productMeta.productId, new ArrayList<>(productIdPrices.keySet())).end()
                .includeScalar(productMeta.productId)
                .includeScalar(productMeta.currentUnitPrice)
                .build();
        QueryExecutionResult<ProductResult> executionResult;
        try {
            executionResult = databaseService.executeQuery(query);
        } catch (PostgresExecutionException e) {
            throw GraphQLRequestException.createInternal(e);
        }
        ImmutableList<ProductResult> productResults = executionResult.deserialize();
        for (ProductResult productResult : productResults) {
            int id = ((IntValue) productResult.getProductId()).getValue();
            BigDecimal userInputPrice = productIdPrices.get(id);
            BigDecimal currentActualPrice = ((BigDecimalValue) productResult.getCurrentUnitPrice()).getValue();
            if(!currentActualPrice.equals(userInputPrice)){
                throw new GraphQLRequestException(String.format("Invalid unit price for product id: [%s]. " +
                        "Current price is [%s], but price submitted was [%s].", id, currentActualPrice, userInputPrice),
                        GraphQLErrorTypeCategory.VALIDATION);
            }
        }
        return new MutationFieldAndCookies(placeOrderMutationField, List.of());
    }

    public static GraphQLTypeConfiguration<PurchaseOrderResult> createStaffApiTypeConfiguration(PurchaseOrderMeta purchaseOrderMeta) {
        GraphQLDatabaseQueryConfiguration<PurchaseOrderResult> queryConfiguration =
                new GraphQLDatabaseQueryConfiguration<>(Set.of(purchaseOrderMeta.purchaseOrderId,
                        purchaseOrderMeta.orderStatus, purchaseOrderMeta.customer, purchaseOrderMeta.phoneNumber,
                        purchaseOrderMeta.address, purchaseOrderMeta.name,
                        purchaseOrderMeta.createdAt, purchaseOrderMeta.lastUpdatedAt, purchaseOrderMeta.orderLines))
                        .setIncludePluralRootField(true)
                .setIncludeOrderBy(Set.of(purchaseOrderMeta.purchaseOrderId, purchaseOrderMeta.createdAt, purchaseOrderMeta.lastUpdatedAt))
                .setIncludeWhere(Set.of(purchaseOrderMeta.purchaseOrderId, purchaseOrderMeta.createdAt,
                        purchaseOrderMeta.lastUpdatedAt, purchaseOrderMeta.customerId, purchaseOrderMeta.orderStatus), false)
                .setPluralFieldDescription("Returns all orders from all users.");
        GraphQLMutationsConfiguration<PurchaseOrderResult> mutationConfiguration =
                new GraphQLMutationsConfiguration<>(Set.of(purchaseOrderMeta.purchaseOrderId, purchaseOrderMeta.orderStatus))
                .setIncludeUpdate(Set.of(purchaseOrderMeta.purchaseOrderId, purchaseOrderMeta.orderStatus), false)
                .setBatchMutationFieldEnabled("orderStatusBatchUpdate",
                        String.format("Updates the order status of a list of orders. Valid values are: [%s, %s]",
                                SHIPPED, IN_PROGRESS));
        return new GraphQLTypeConfiguration<>(purchaseOrderMeta.getEntityMetadata())
                .setIncludeQuery(queryConfiguration)
                .setIncludeMutations(mutationConfiguration)
                .setTypeName(apiBaseName, apiPluralName);
    }

    public void checkStaffUpdateOrderStatuses(OrderStatusBatchUpdateMutationField databaseMutation) throws GraphQLRequestException {
        if (databaseMutation.purchaseOrdersToUpdate().size() > 50) {
            throw new GraphQLRequestException("Request too big.", GraphQLErrorTypeCategory.OTHER);
        }
        for (PurchaseOrderToUpdate purchaseOrderToUpdate : databaseMutation.purchaseOrdersToUpdate()) {
            IncludableString includableOrderStatusName = purchaseOrderToUpdate.getOrderStatus();
            if(!(includableOrderStatusName instanceof StringValue stringValue)){
                throw new GraphQLRequestException(String.format("Missing updated status for order id: [%s].",
                        purchaseOrderToUpdate.getWherePurchaseOrderId()), GraphQLErrorTypeCategory.OTHER);
            }
            String orderStatusName = stringValue.getValue();
            OrderStatusEnum orderStatus;
            try {
                orderStatus = OrderStatusEnum.valueOf(orderStatusName);
            } catch (IllegalArgumentException e) {
                throw new GraphQLRequestException(String.format("Invalid orderStatus value for id: [%s]. Expected one of values: %s",
                        purchaseOrderToUpdate.getWherePurchaseOrderId(), Arrays.toString(OrderStatusEnum.values())), GraphQLErrorTypeCategory.OTHER);
            }
            switch (orderStatus){
            case SHIPPED, IN_PROGRESS: break;
            default: throw new GraphQLRequestException(String.format("Not allowed to set orderStatus to anything other " +
                    "than \"%s\" or \"%s\".", SHIPPED, IN_PROGRESS), GraphQLErrorTypeCategory.OTHER);
            }

            if(originalDatasetIds.contains(purchaseOrderToUpdate.getWherePurchaseOrderId())){
                throw new GraphQLRequestException(String.format("Not allowed to update the main dataset in this demo. " +
                                "If you want to update a purchase-order, create a new one first and " +
                                "then update that one. Invalid update for id: [%s]",
                        purchaseOrderToUpdate.getWherePurchaseOrderId()),
                        GraphQLErrorTypeCategory.OTHER);
            }
        }
    }
}
